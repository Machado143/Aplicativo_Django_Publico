<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmx-config" content='{"selfRequestsOnly":false,"withCredentials":true}'>
    <title>Farmácia - Posts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/estilo.css">
</head>

<body>
    <!-- Barra de Navegação -->
    <div id="botoes">
        <a href="#" onclick="loadPosts(); return false;">Inicio</a>
        <a href="http://127.0.0.1:8000/postar/">Postar (Login Required)</a>
        <a href="http://127.0.0.1:8000/Postagens/">Ver Todos Posts (Django)</a>
        <a href="http://127.0.0.1:8000/contas/login/">Login</a>
    </div>

    <!-- Conteúdo Principal -->
    <div id="conteudo" style="margin-top: 100px; padding: 20px;"></div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';

        // Carregar posts ao abrir a página
        document.addEventListener('DOMContentLoaded', loadPosts);

        // Buscar e exibir posts
        async function loadPosts() {
            const conteudo = document.getElementById('conteudo');
            conteudo.innerHTML = '<p style="text-align: center;">Carregando posts...</p>';

            try {
                const response = await fetch(`${API_URL}/api/posts/`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const posts = await response.json();
                console.log('Posts:', posts);

                if (!posts || posts.length === 0) {
                    conteudo.innerHTML = `
                        <div class="alert alert-info text-center" role="alert">
                            <h5>Nenhuma postagem aprovada ainda.</h5>
                        </div>
                    `;
                    return;
                }

                // Renderizar posts
                let html = '<h1 style="margin-bottom: 40px;">Postagens</h1><div id="todos_posts">';
                
                posts.forEach(post => {
                    const dataFormatada = new Date(post.data_postagem)
                        .toLocaleDateString('pt-BR', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                    html += `
                        <div class="postagem">
                            <h3>${escapeHtml(post.autor)}</h3>
                            ${post.imagem_url ? `<img src="${API_URL}${post.imagem_url}" alt="Imagem">` : ''}
                            <p>${escapeHtml(post.mensagem)}</p>
                            <small>Postado em: ${dataFormatada}</small>
                        </div>
                    `;
                });

                html += '</div>';
                conteudo.innerHTML = html;

            } catch (error) {
                console.error('Erro:', error);
                conteudo.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <strong>Erro ao carregar posts:</strong> ${error.message}
                        <br><small>Verifique se o Django está rodando em http://127.0.0.1:8000</small>
                    </div>
                `;
            }
        }

        // Escapar HTML para segurança
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>